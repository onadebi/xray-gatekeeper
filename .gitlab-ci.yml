#include:
#  project: 'corp/automation/cicd/templates'
#  ref: 1.0.17
#  file:
#    - '/pipelines/templates/common-automation-settings.yml'
#    - '/pipelines/templates/common-automation-workflow.yml'
#    - '/pipelines/templates/common-automation-prereq-test.yml'
#    - '/pipelines/templates/common-automation-prereq-gitlab-scanning.yml'

image: openjdk:21-jdk-slim

services:
  - name: docker:19-dind
    alias: docker
    command: ["--dns", "8.8.8.8", "--dns", "8.8.4.4"]

default:
  tags:
    - dc:london

variables:
  SSH_PRIVATE_KEY: $SSH_PRIVATE_KEY
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_IMAGE: $CI_REGISTRY/corp/automation/libraries/xray-gatekeeper/xray-gatekeeper-api
  CI_REGISTRY: $CI_REGISTRY
  CI_REGISTRY_USER: gitlab-ci-token
  CI_REGISTRY_PASSWORD: $CI_REGISTRY_PASSWORD

stages:
  - build
  - deploy

before_script:
  - apk update && apk add openssh-client bind-tools curl sudo
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > /tmp/id_rsa
  - chmod 600 /tmp/id_rsa
  - ssh-add /tmp/id_rsa
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - echo "172.16.139.79 lops-qate-xmf1" >> /etc/hosts
  - ssh-keyscan 172.16.139.79 >> ~/.ssh/known_hosts
  - curl -L "https://github.com/docker/compose/releases/download/v2.3.3/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  - docker-compose -v  # Verify installation
  # Download and install OpenJDK 21
#  - echo "Installing OpenJDK 21..."
#  - mkdir -p /opt/jdk
#  - curl -L "https://download.oracle.com/java/21/latest/jdk-21_linux-x64_bin.tar.gz" -o /tmp/openjdk-21.tar.gz
#  - tar -xzvf /tmp/openjdk-21.tar.gz -C /opt/jdk
#  - export PATH="/opt/jdk/jdk-21/bin:$PATH"
#  - ls /opt/jdk/jdk-21/bin
#  - echo $PATH
  - java -version

build:
  stage: build
  script:
    - echo "Building the Docker image..."
#    - docker build -t $DOCKER_IMAGE .
    - docker-compose -f "$CI_PROJECT_DIR/docker-compose.yml" up -d --build
    - echo "Logging in to the GitLab container registry..."
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - echo "Pushing image to registry..."
    - docker push $DOCKER_IMAGE || { echo 'Docker push failed'; exit 1; }
    - echo "Build stage succeed!"

  only:
    - feature/sqa-613-deploy_update
  when: manual
  variables:
    DOCKER_DRIVER: overlay2
  services:
    - name: docker:19-dind
      alias: docker
      command: ["--dns", "8.8.8.8", "--dns", "8.8.4.4"]

deploy:
  stage: deploy
  needs: ["build"]
  script:
    - echo "Deploying the application..."

  only:
    - feature/sqa-613-deploy_update
  when: manual
  services:
    - name: docker:19-dind
      alias: docker
      command: ["--dns", "8.8.8.8", "--dns", "8.8.4.4"]
